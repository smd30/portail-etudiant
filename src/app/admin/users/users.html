

<div class="content">
    <div class="container-fluid">
        
        <div class="card mb-4 p-3">

            <div class="row page-titles mx-0 ">

                <div class="col-sm-4 p-md-0">
                    <div class="welcome-text">
                        <h4>Utilisateurs</h4>
                        <span class="ml-1">Gestion des utilisateurs</span>
                    </div>
                </div>
        
                <div class="col-sm-4 p-md-0">
                    <select [(ngModel)]="roleFilter" (change)="applyFilter()" class="form-control">
                        <option value="">-- Filtrer par rôle --</option>
                        <option value="administrateur">Administrateur</option>
                        <option value="enseignant">Enseignant</option>
                        <option value="eleve_parent">Élève/Parent</option>
                    </select>
                </div>
        
                <div class="col-sm-4 p-md-0 d-flex justify-content-sm-end">
                    <div class="bnt">
                        <button class="btn btn-primary" (click)="openAddModal()">+ Ajouter</button>
                    </div>
                </div>

            </div>

        </div>
  
      <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
  
      <div class="card">
        <div class="card-header"><h4 class="card-title">Liste des utilisateurs</h4></div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="thead-dark">
                <tr class="table-active">
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Email</th>
                  <th>Rôle</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="isLoading">
                  <td colspan="5" class="text-center">Chargement en cours...</td>
                </tr>
                <tr *ngFor="let user of filteredUsers">
                  <td>{{ user.nom }}</td>
                  <td>{{ user.prenom }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ getRoleLabel(user.role) }}</td>
                  <td class="text-center">
                    <div class="d-grid g-4 d-md-flex justify-content-md-end">
                      <button class="btn btn-sm btn-warning text-white" (click)="openEditModal(user)">Modifier</button>
                      &nbsp; &nbsp; &nbsp;
                      <button class="btn btn-sm btn-danger" (click)="openDeleteModal(user)">Supprimer</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal pour ajouter/modifier un utilisateur -->
  <app-modal [isOpen]="isModalOpen" (close)="isModalOpen = false">
    <h5 class="modal-title">Utilisateur</h5>
    
    <form (ngSubmit)="submitForm()">
      <div class="modal-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom</label>
          <input type="text" name="nom" [(ngModel)]="formData.nom" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Prénom</label>
          <input type="text" name="prenom" [(ngModel)]="formData.prenom" class="form-control" required>
        </div>
        <div class="col-md-6 mt-3">
          <label class="form-label">Email</label>
          <input type="email" name="email" [(ngModel)]="formData.email" class="form-control" required>
        </div>
        <div class="col-md-6 mt-3">
          <label class="form-label">Téléphone</label>
          <input type="text" name="telephone" [(ngModel)]="formData.telephone" class="form-control">
        </div>
        <div class="col-md-6 mt-3">
          <label class="form-label">Adresse</label>
          <input type="text" name="addresse" [(ngModel)]="formData.addresse" class="form-control">
        </div>
        <div class="col-md-6 mt-3">
          <div class="form-group">
            <label>Sexe</label>
            <select class="form-control" name="sexe" [(ngModel)]="formData.sexe">
              <option value="">Sélectionner</option>
              <option value="homme">Homme</option>
              <option value="femme">Femme</option>
            </select>
          </div>
        </div>
        <div class="col-md-6 mt-3">
          <div class="form-group">
            <label>Rôle</label>
            <select name="role" class="form-control" [(ngModel)]="formData.role">
              <option value="administrateur">Administrateur</option>
              <option value="enseignant">Enseignant</option>
              <option value="eleve_parent">Élève/Parent</option>
            </select>
          </div>
        </div>
        
        <div class="col-md-6 mt-3" *ngIf="toggleEleveFields()">
          <label class="form-label">Date de naissance</label>
          <input type="date" name="date_naissane" [(ngModel)]="formData.date_naissane" class="form-control">
        </div>
        <div class="col-md-6 mt-3" *ngIf="toggleEleveFields()">
          <label class="form-label">Lieu de naissance</label>
          <input type="text" name="lieu" [(ngModel)]="formData.lieu" class="form-control">
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="isModalOpen = false">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="isLoading">
          {{ isLoading ? 'Enregistrement...' : 'Enregistrer' }}
        </button>
      </div>
    </form>
  </app-modal>
  
  <!-- Modal de confirmation de suppression -->
  <app-confirm-modal 
    [isOpen]="isDeleteModalOpen" 
    (confirm)="deleteUser()" 
    (cancel)="isDeleteModalOpen = false">
    <p>Supprimer cet utilisateur ?</p>
  </app-confirm-modal>